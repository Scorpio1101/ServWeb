<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Usuarios</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css"
    integrity="sha384-aFq/bzH65dt+w6FI2ooMVUpc+21e0SRygnTpmBvdBgSdnuTN7QbdgL+OapgHtvPp" crossorigin="anonymous">
  <link rel="stylesheet" href="../CSS/Agregar.css">
</head>

<body>
  <header>
    <div class="volver-container">
      <a href="javascript:history.go(-1)">
        <img src="../IMÁGENES/volver.png" alt="Botón Volver">
      </a>
    </div>
    <a href="../HTML/PrincipalAdmin.html">
      <img src="../IMÁGENES/Logo.png">
    </a>
    <h1>Agregar Usuario</h1>
  </header>

  <div class="container mt-5 text-white">
    <div class="main row justify-content-center">
      <div class="col-8 mb-3 form-group">
        <label for="first_name" class="form-label">Nombre</label>
        <input class="form-control" id="first_name" type="text" placeholder="Ingrese el nombre">
      </div>

      <div class="col-8 mb-3 form-group">
        <label for="last_name" class="form-label">Apellidos</label>
        <input class="form-control" id="last_name" type="text" placeholder="Ingrese los apellidos">
      </div>

      <div class="col-8 mb-3 form-group">
        <label for="roles" class="form-label">Tipo de usuario</label>
        <select id="roles">
          <option value="" disabled selected>Seleccione un rol</option>
          <option value="administrador">Administrador</option>
          <option value="miembro">Miembro</option>
        </select>
      </div>

      <div class="col-8 mb-3 form-group">
        <label for="dni" class="form-label">Cédula</label>
        <input class="form-control" id="dni" type="text" placeholder="Ingrese la cédula">
      </div>

      <div class="col-8 mb-3 form-group">
        <label for="email" class="form-label">Email</label>
        <input class="form-control" id="email" type="email" placeholder="Ingrese el email">
      </div>

      <div class="col-8 mb-3 form-group">
        <label for="password" class="form-label">Password</label>
        <div class="input-group">
          <input class="form-control" id="password" type="password" placeholder="Genere una contraseña">
          <button class="btn btn-generate-password" onclick="generarContrasena()">Generar Contraseña</button>
          <button class="btn btn-toggle-password" onclick="togglePasswordVisibility()">Mostrar</button>
        </div>
      </div>

      <script>
        function generarContrasena() {
          var caracteres = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
          var longitud = 10;
          var contrasena = "";

          for (var i = 0; i < longitud; i++) {
            var indice = Math.floor(Math.random() * caracteres.length);
            contrasena += caracteres.charAt(indice);
          }

          document.getElementById("password").value = contrasena;
        }

        function togglePasswordVisibility() {
          var passwordInput = document.getElementById("password");
          var toggleButton = document.querySelector(".btn-toggle-password");

          if (passwordInput.type === "password") {
            passwordInput.type = "text";
            toggleButton.textContent = "Ocultar";
          } else {
            passwordInput.type = "password";
            toggleButton.textContent = "Mostrar";
          }
        }
      </script>

      <div class="col-8">
        <button class="btn btn-success" type="submit" id="submit-button" onclick="register()">Agregar</button>
      </div>

      <div class="col-10 mt-5">
        <table class="table text-white m-4">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Apellidos</th>
              <th>Usuario</th>
              <th>Cédula</th>
              <th>Correo</th>
              <th>Contraseña</th>
              <th></th>
            </tr>
          </thead>
          <tbody class="user-list">
            <tr>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td>
                <button class="btn btn-warning btn-sm edit" data-id="${usuario.id}">Editar</button>
                <button class="btn btn-danger btn-sm delete" data-id="${usuario.id}">Eliminar</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</body>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

<script>
  // Initialize Firebase and get a reference to the database
  var firebaseConfig = {
    apiKey: "AIzaSyAUuOzPZ1k3-YKMtQzO1AX9XE_hUgS0LhA",
    authDomain: "bibliotek-6aa3f.firebaseapp.com",
    databaseURL: "https://bibliotek-6aa3f-default-rtdb.firebaseio.com",
    projectId: "bibliotek-6aa3f",
    storageBucket: "bibliotek-6aa3f.appspot.com",
    messagingSenderId: "459978600030",
    appId: "1:459978600030:web:ccd097da5ab5c2c72a4ecf"
  };
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  function register () {
  // Obtén todos nuestros campos de entrada
  email = document.getElementById('email').value
  password = document.getElementById('password').value
  first_name = document.getElementById('first_name').value
  last_name = document.getElementById('last_name').value
  dni = document.getElementById('dni').value
  roles = document.getElementById('roles').value

  // Valida los campos de entrada
  if (validate_field(first_name) == false || validate_field(last_name) == false || validate_field(dni) == false){
    alert('Debe rellenar los campos vacíos')
    return
  }
  if (validate_email(email) == false || validate_password(password) == false) {
    alert('Debe digitar un correo o contraseña válidos')
    return
    // No continúes ejecutando el código
  }

  // Continúa con la autenticación
  auth.createUserWithEmailAndPassword(email, password)
  .then(function() {
    // Obtiene el usuario actual
    var user = auth.currentUser

    // Agrega este usuario a la base de datos de Firebase
    var database_ref = database.ref('/');

    // Crea los datos del usuario
    var user_data = {
      email : email,
      first_name : first_name,
      last_name : last_name,
      last_login : Date.now(),
      dni : dni,
      roles : roles,
      password: password // Agrega el campo Contraseña
    }

    // Agrega a la base de datos de Firebase
    database_ref.child('users/' + user.uid).set(user_data)

    // Listo
    alert('Usuario creado satisfactoriamente!');
    //window.location.href = "../HTML/Login.html";
  })
  .catch(function(error) {
    // Firebase utilizará esto para alertar de sus errores
    var error_code = error.code
    var error_message = error.message

    alert(error_message)
  })
}

  // Listen for changes in the users' data and update the table
  database.ref("users").on("child_added", snapshot => {
    const user = snapshot.val();

    const newRow = document.createElement("tr");
    newRow.innerHTML = `
      <td>${user.first_name}</td>
      <td>${user.last_name}</td>
      <td>${user.roles}</td>
      <td>${user.dni}</td>
      <td>${user.email}</td>
      <td>${user.password}</td>
      <td>
          <button class="btn btn-warning btn-sm edit" data-id="${snapshot.key}">Editar</button>
          <button class="btn btn-danger btn-sm delete" data-id="${snapshot.key}">Eliminar</button>
        </td>
      `;

    document.querySelector(".user-list").appendChild(newRow);
  });

  // Add event listeners for edit and delete buttons (similar to books)
  document.addEventListener("click", function (event) {
    if (event.target.classList.contains("edit")) {
      const userId = event.target.getAttribute("data-id");

      // Retrieve user data based on userId and populate the form for editing
      // Implement the logic to update user data and save it back to the database
    } else if (event.target.classList.contains("delete")) {
      const userId = event.target.getAttribute("data-id");

      // Delete the user data from the Firebase Realtime Database
      database.ref("users").child(userId).remove();

      // Remove the row from the table immediately after deletion
      event.target.closest("tr").remove();
      console.log("Delete button clicked for user with ID:", userId);
    }
  });
</script>

</html>